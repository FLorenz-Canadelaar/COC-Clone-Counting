<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>COC – Stecklingszählung</title>
  <style>
    :root{ --brand:#E87722; --bg:#fff7f0; --txt:#1a1a1a; --muted:#666; --card:#ffffff; --border:#ccc; --radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--txt);background:var(--bg)}
    header{background:var(--brand);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:10}
    .wrap{max-width:1000px;margin:18px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.05)}
    .grid{display:grid;gap:12px}
    .grid.cols{grid-template-columns:1fr 1fr}
    label{font-size:14px;color:var(--muted)}
    input[type=text],input[type=number]{width:100%;padding:10px 12px;border:1.5px solid #b5b5b5;border-radius:10px;background:#fff;font-size:16px}
    input[type=text]:focus,input[type=number]:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(232,119,34,.18);outline:none}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:8px 10px;vertical-align:middle}
    th{font-size:12px;color:var(--muted);text-align:left}
    tr{background:#fff;border:1px solid var(--border)}
    tr td:first-child,tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .code{font-weight:700; letter-spacing:0.2px}
    .qty input{width:120px}
    .satz input{min-width:160px}
    .actions .btn{appearance:none;border:none;border-radius:10px;padding:8px 10px;font-weight:600;font-size:14px;cursor:pointer}
    .btn{appearance:none;border:none;border-radius:10px;padding:8px 12px;font-weight:600;font-size:14px;cursor:pointer}
    .btn-ghost{background:#fff;border:1px solid var(--border)}
    .btn-primary{background:var(--brand);color:#fff;border:none}
    .btn-danger{background:#b00020;color:#fff;border:none}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .search-wrap{position:relative;max-width:360px;width:100%}
    .search-wrap svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;fill:#999}
    #search{width:100%;padding-left:40px;border:2px solid var(--border);border-radius:12px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
<header><div style="font-weight:800">COC</div><div><div style="font-weight:700">Stecklingszählung</div><div style="font-size:12px;color:#eee">Offline-fähige Mini-App</div></div></header>

<main class="wrap grid" style="gap:16px">
  <section class="card">
    <div class="grid cols" style="align-items:end">
      <div><label for="datum">Datum</label><input id="datum" type="date"></div>
      <div><label for="bearbeiter">Mitarbeiter*in (optional)</label><input id="bearbeiter" type="text" placeholder="Name oder Kürzel"></div>
    </div>
    <div class="grid" style="margin-top:8px">
      <div><label for="bemerkung">Bemerkung (optional)</label><input id="bemerkung" type="text" placeholder="z. B. Zwischenzählung, Raum A"></div>
    </div>
  </section>

  <section class="card">
    <div class="toolbar">
      <div class="search-wrap">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.53 20.47l-4.82-4.82A7.92 7.92 0 0018 10a8 8 0 10-8 8 7.92 7.92 0 005.65-1.29l4.82 4.82a.75.75 0 101.06-1.06zM4.5 10a5.5 5.5 0 1111 0 5.5 5.5 0 01-11 0z"/></svg>
        <input id="search" type="text" placeholder="Sorte/Abkürzung suchen…">
      </div>
      <div class="muted" id="rowCount"></div>
    </div>
    <div id="tableWrap"></div>
  </section>

  <section class="card">
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn btn-primary" id="btnSave">Speichern & CSV herunterladen</button>
      <button class="btn btn-ghost" id="btnClear">Alle Mengen und Satznummern leeren</button>
    </div>
  </section>
</main>

<script>
var SORTEN = [
  {code:'AMC', name:'Amnesia Master Cut (Gold)'},
  {code:'ACC', name:'Amnesia Core Cut'},
  {code:'AMM', name:'Amnesia Sascha'},
  {code:'WED', name:'Wedding Cake'},
  {code:'CJ',  name:'Cap Junky'},
  {code:'PM',  name:'Permanent Marker'},
  {code:'GCI', name:'Graps & Creme imp.'},
  {code:'SSH', name:'Super Silver Haze'},
  {code:'LH',  name:'Lemon Haze (T. Amnesia Haze)'},
  {code:'J31', name:'Jokerz 31'},
  {code:'RS',  name:'Rainbow Sherbert 11'},
  {code:'SOG', name:'Super Orange Glue'},
  {code:'MATO',name:'MATO Power Plant (Exklusiv)'},
  {code:'MOP', name:'Mimosa x Orange Punch'},
  {code:'BCP', name:'Black Cherry Punch'}
];

function $(s){ return document.querySelector(s); }

function makeRow(code, name){
  var tr = document.createElement('tr');
  tr.innerHTML = ''+
    '<td class="code">'+code+'</td>'+
    '<td>'+name+'</td>'+
    '<td class="satz"><input type="text" class="satznummer" placeholder="Satznummer"></td>'+
    '<td class="qty"><input type="number" min="0" value="0" class="menge"></td>'+
    '<td class="actions">'+
      '<button class="btn btn-ghost btnAdd" type="button" title="Weitere Zeile für diese Sorte">＋</button> '+
      '<button class="btn btn-danger btnDel" type="button" title="Zeile entfernen">−</button>'+
    '</td>';
  return tr;
}

function buildTable(filter){
  if(!filter){ filter = ''; }
  var wrap = document.getElementById('tableWrap');
  wrap.innerHTML = '';
  var table = document.createElement('table');
  table.innerHTML = '<thead><tr>'+
    '<th style="width:90px">Code</th>'+
    '<th>Sorte</th>'+
    '<th style="width:200px">Satznummer</th>'+
    '<th style="width:140px">Menge</th>'+
    '<th style="width:150px">Aktion</th>'+
  '</tr></thead>';
  var tbody = document.createElement('tbody');

  var f = (filter+'').toLowerCase();
  for(var i=0;i<SORTEN.length;i++){
    var s = SORTEN[i];
    if(f && s.code.toLowerCase().indexOf(f)===-1 && s.name.toLowerCase().indexOf(f)===-1) continue;
    tbody.appendChild(makeRow(s.code, s.name));
  }
  table.appendChild(tbody);
  wrap.appendChild(table);

  tbody.addEventListener('click', function(ev){
    var t = ev.target || ev.srcElement;
    if(!t.classList) return;
    if(t.classList.contains('btnAdd')){
      var tr = t.closest ? t.closest('tr') : closestTR(t);
      var code = tr.children[0].textContent;
      var name = tr.children[1].textContent;
      var newRow = makeRow(code, name);
      tr.parentNode.insertBefore(newRow, tr.nextSibling);
      updateRowCount();
    } else if(t.classList.contains('btnDel')){
      var trd = t.closest ? t.closest('tr') : closestTR(t);
      trd.parentNode.removeChild(trd);
      updateRowCount();
    }
  });

  updateRowCount();
}

function closestTR(el){
  while(el && el.tagName !== 'TR'){ el = el.parentNode; }
  return el;
}

function updateRowCount(){
  var n = document.querySelectorAll('#tableWrap tbody tr').length;
  var el = document.getElementById('rowCount');
  if(el){ el.textContent = n + ' Zeilen'; }
}

function exportCSV(){
  var datumVal = document.getElementById('datum').value || new Date().toISOString().slice(0,10);
  var bearb = document.getElementById('bearbeiter').value || '';
  var bemerk = document.getElementById('bemerkung').value || '';

  var rows = [];
  var trs = document.querySelectorAll('#tableWrap tbody tr');
  for(var i=0;i<trs.length;i++){
    var tds = trs[i].children;
    var code = tds[0].textContent;
    var name = tds[1].textContent;
    var satz = tds[2].querySelector('input').value || '';
    var menge = tds[3].querySelector('input').value;
    var qty = menge ? Number(menge) : 0;
    rows.push({Datum:datumVal, Mitarbeiter:bearb, Bemerkung:bemerk, Code:code, Sorte:name, Satznummer:satz, Menge:qty});
  }

  if(!rows.length){ alert('Keine Zeilen vorhanden.'); return; }

  var header = Object.keys(rows[0]);
  var esc = function(v){ var s=(v==null?'':String(v)).replace(/"/g,'""'); return /[";,\n]/.test(s)?'"'+s+'"':s; };
  var out = [header.join(';')];
  for(var r=0;r<rows.length;r++){
    var line=[]; for(var h=0;h<header.length;h++){ line.push(esc(rows[r][header[h]])); }
    out.push(line.join(';'));
  }
  var blob = new Blob([out.join('\n')], {type:'text/csv;charset=utf-8;'});
  var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Stecklingszaehlung.csv'; a.click(); URL.revokeObjectURL(a.href);
}

document.addEventListener('DOMContentLoaded', function(){
  var d = document.getElementById('datum'); if(d){ d.value = new Date().toISOString().slice(0,10); }
  buildTable('');

  var search = document.getElementById('search');
  if(search){ search.addEventListener('input', function(e){ buildTable(e.target.value); }); }

  document.getElementById('btnSave').onclick = exportCSV;
  document.getElementById('btnClear').onclick = function(){
    var satz = document.querySelectorAll('.satznummer'); for(var i=0;i<satz.length;i++){ satz[i].value=''; }
    var qtys = document.querySelectorAll('.menge'); for(var j=0;j<qtys.length;j++){ qtys[j].value='0'; }
  };
});
</script>
</body>
</html>